"use strict";(()=>{var e={};e.id=5781,e.ids=[5781],e.modules={3524:e=>{e.exports=require("@prisma/client")},9344:e=>{e.exports=require("jsonwebtoken")},145:e=>{e.exports=require("next/dist/compiled/next-server/pages-api.runtime.prod.js")},6249:(e,t)=>{Object.defineProperty(t,"l",{enumerable:!0,get:function(){return function e(t,a){return a in t?t[a]:"then"in t&&"function"==typeof t.then?t.then(t=>e(t,a)):"function"==typeof t&&"default"===a?t:void 0}}})},8847:(e,t,a)=>{a.r(t),a.d(t,{config:()=>f,default:()=>p,routeModule:()=>_});var r={};a.r(r),a.d(r,{default:()=>m});var n=a(1802),i=a(7153),s=a(6249),d=a(3382);let o=new(a(3524)).PrismaClient,u=[],c=async(e,t)=>{if("GET"===e.method){t.writeHead(200,{"Content-Type":"text/event-stream","Cache-Control":"no-cache",Connection:"keep-alive","Access-Control-Allow-Origin":"*","Access-Control-Allow-Headers":"Cache-Control"});let a=Date.now();u.push({id:a,response:t}),t.write(`data: ${JSON.stringify({type:"connected",clientId:a})}

`);let r=setInterval(()=>{t.write(`data: ${JSON.stringify({type:"ping",timestamp:new Date().toISOString()})}

`)},3e4);e.on("close",()=>{clearInterval(r),u=u.filter(e=>e.id!==a)});return}if("POST"===e.method)try{let a=e.body;if(!a.device_id||!a.user_id||!a.timestamp)return t.status(400).json({success:!1,message:"Device ID, User ID, dan timestamp diperlukan"});let r={id:Date.now(),karyawan_id:parseInt(a.user_id),device_id:a.device_id,timestamp:a.timestamp,type:0===a.in_out_mode?"masuk":"keluar",verify_method:function(e){switch(e){case 1:default:return"fingerprint";case 15:return"face";case 2:return"card"}}(a.verify_type),status:function(e){let t=new Date(e.timestamp),a=t.getHours(),r=t.getMinutes();return 0===e.in_out_mode?a>8||8===a&&r>0?"terlambat":"hadir":a<17?"pulang_cepat":"hadir"}(a),created_at:new Date().toISOString()},n=await o.fingerprintAttendance.create({data:{user_id:r.karyawan_id,device_user_id:a.user_id,device_id:r.device_id,attendance_time:new Date(r.timestamp),attendance_type:a.in_out_mode,verification_type:r.verify_method,is_realtime:!0,created_at:new Date,updated_at:new Date},include:{user:{select:{id:!0,nama_pegawai:!0,device_user_id:!0,cabang:{select:{id:!0,nama_cabang:!0}}}}}});return l({type:"attendance_record",data:n}),t.status(200).json({success:!0,message:"Data kehadiran berhasil diproses",data:r})}catch(e){return t.status(500).json({success:!1,message:"Gagal memproses data fingerprint"})}finally{await o.$disconnect()}return"DELETE"===e.method?(await o.fingerprintAttendance.deleteMany({}),l({type:"records_cleared",data:null}),t.status(200).json({success:!0,message:"Semua rekaman berhasil dihapus"})):t.status(405).json({success:!1,message:"Method tidak diizinkan"})};function l(e){let t=`data: ${JSON.stringify(e)}

`;u.forEach((e,a)=>{try{e.response.write(t)}catch(e){u.splice(a,1)}})}let m=async(e,t)=>(!e.headers.authorization&&e.query.token&&(e.headers.authorization=`Bearer ${e.query.token}`),(0,d.Q)(c)(e,t)),p=(0,s.l)(r,"default"),f=(0,s.l)(r,"config"),_=new n.PagesAPIRouteModule({definition:{kind:i.x.PAGES_API,page:"/api/fingerprint/realtime",pathname:"/api/fingerprint/realtime",bundlePath:"",filename:""},userland:r})},3382:(e,t,a)=>{a.d(t,{Q:()=>i,c:()=>s});var r=a(9344),n=a.n(r);function i(e,t){return async(a,r)=>{try{let i=a.headers.authorization;if(!i||!i.startsWith("Bearer "))return r.status(401).json({message:"No token provided"});let s=i.substring(7),d=n().verify(s,"afms-jwt-secret-key-2024");if(!d||!d.id)return r.status(401).json({message:"Token tidak valid"});if(a.user={id:d.id,userId:parseInt(d.id)||1,email:d.email||"",name:d.name||"",role:d.role||"admin"},t&&!(Array.isArray(t)?t:[t]).includes(a.user.role))return r.status(403).json({message:"Insufficient permissions"});return await e(a,r)}catch(e){return r.status(401).json({message:"Token tidak valid"})}}}function s(e){return i(e,"admin")}},7153:(e,t)=>{var a;Object.defineProperty(t,"x",{enumerable:!0,get:function(){return a}}),function(e){e.PAGES="PAGES",e.PAGES_API="PAGES_API",e.APP_PAGE="APP_PAGE",e.APP_ROUTE="APP_ROUTE"}(a||(a={}))},1802:(e,t,a)=>{e.exports=a(145)}};var t=require("../../../webpack-api-runtime.js");t.C(e);var a=t(t.s=8847);module.exports=a})();