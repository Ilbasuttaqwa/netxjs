"use strict";(()=>{var e={};e.id=839,e.ids=[839],e.modules={3524:e=>{e.exports=require("@prisma/client")},9344:e=>{e.exports=require("jsonwebtoken")},145:e=>{e.exports=require("next/dist/compiled/next-server/pages-api.runtime.prod.js")},6249:(e,t)=>{Object.defineProperty(t,"l",{enumerable:!0,get:function(){return function e(t,s){return s in t?t[s]:"then"in t&&"function"==typeof t.then?t.then(t=>e(t,s)):"function"==typeof t&&"default"===s?t:void 0}}})},9167:(e,t,s)=>{s.r(t),s.d(t,{config:()=>m,default:()=>l,routeModule:()=>f});var a={};s.r(a),s.d(a,{default:()=>o});var i=s(1802),n=s(7153),r=s(6249),u=s(3382);let c=new(s(3524)).PrismaClient;async function d(e,t){try{switch(e.method){case"POST":let{device_id:s,status:a,firmware_version:i,last_heartbeat:n,error_message:r,employee_count:u,storage_usage:d}=e.body;if(!s||!a)return t.status(400).json({success:!1,message:"Required fields: device_id, status"});let o=await c.device.findFirst({where:{device_id:s}});if(!o)return t.status(404).json({success:!1,message:"Device not found"});let l=await c.device.update({where:{id:o.id},data:{status:"online"===a?"aktif":"offline"===a?"nonaktif":"maintenance",last_sync:new Date,...i&&{firmware_version:i},...r&&{keterangan:r}}});return await c.deviceStatusLog.create({data:{device_id:o.id,status:a,firmware_version:i||o.firmware_version,error_message:r,employee_count:u||0,storage_usage:d||0,timestamp:new Date}}),t.status(200).json({success:!0,message:"Device sync successful",data:{device_id:l.device_id,status:l.status,last_sync:l.last_sync}});case"GET":let{device_id:m,hours:f=24}=e.query,v=parseInt(f.toString()),_={timestamp:{gte:new Date(Date.now()-36e5*v)}};if(m){let e=await c.device.findFirst({where:{device_id:m.toString()}});if(!e)return t.status(404).json({success:!1,message:"Device not found"});_.device_id=e.id}let g=(await c.deviceStatusLog.findMany({where:_,include:{device:{select:{device_id:!0,nama:!0,tipe:!0,cabang:{select:{nama_cabang:!0}}}}},orderBy:{timestamp:"desc"}})).reduce((e,t)=>{let s=t.device.device_id;return e[s]||(e[s]={device_id:s,nama:t.device.nama,tipe:t.device.tipe,cabang:t.device.cabang.nama_cabang,latest_status:t.status,latest_sync:t.timestamp,firmware_version:t.firmware_version,employee_count:t.employee_count,storage_usage:t.storage_usage,error_message:t.error_message,sync_history:[]}),e[s].sync_history.push({status:t.status,timestamp:t.timestamp,error_message:t.error_message}),e},{});return t.status(200).json({success:!0,data:Object.values(g)});default:return t.status(405).json({success:!1,message:"Method not allowed"})}}catch(e){return t.status(500).json({success:!1,message:"Internal server error"})}finally{await c.$disconnect()}}let o=(0,u.c)(d),l=(0,r.l)(a,"default"),m=(0,r.l)(a,"config"),f=new i.PagesAPIRouteModule({definition:{kind:n.x.PAGES_API,page:"/api/devices/sync",pathname:"/api/devices/sync",bundlePath:"",filename:""},userland:a})},3382:(e,t,s)=>{s.d(t,{Q:()=>n,c:()=>r});var a=s(9344),i=s.n(a);function n(e,t){return async(s,a)=>{try{let n=s.headers.authorization;if(!n||!n.startsWith("Bearer "))return a.status(401).json({message:"No token provided"});let r=n.substring(7),u=i().verify(r,"afms-jwt-secret-key-2024");if(!u||!u.id)return a.status(401).json({message:"Token tidak valid"});if(s.user={id:u.id,userId:parseInt(u.id)||1,email:u.email||"",name:u.name||"",role:u.role||"admin"},t&&!(Array.isArray(t)?t:[t]).includes(s.user.role))return a.status(403).json({message:"Insufficient permissions"});return await e(s,a)}catch(e){return a.status(401).json({message:"Token tidak valid"})}}}function r(e){return n(e,"admin")}},7153:(e,t)=>{var s;Object.defineProperty(t,"x",{enumerable:!0,get:function(){return s}}),function(e){e.PAGES="PAGES",e.PAGES_API="PAGES_API",e.APP_PAGE="APP_PAGE",e.APP_ROUTE="APP_ROUTE"}(s||(s={}))},1802:(e,t,s)=>{e.exports=s(145)}};var t=require("../../../webpack-api-runtime.js");t.C(e);var s=t(t.s=9167);module.exports=s})();