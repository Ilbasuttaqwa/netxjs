"use strict";(()=>{var e={};e.id=3670,e.ids=[3670],e.modules={3524:e=>{e.exports=require("@prisma/client")},9344:e=>{e.exports=require("jsonwebtoken")},145:e=>{e.exports=require("next/dist/compiled/next-server/pages-api.runtime.prod.js")},6249:(e,s)=>{Object.defineProperty(s,"l",{enumerable:!0,get:function(){return function e(s,t){return t in s?s[t]:"then"in s&&"function"==typeof s.then?s.then(s=>e(s,t)):"function"==typeof s&&"default"===t?s:void 0}}})},9111:(e,s,t)=>{t.r(s),t.d(s,{config:()=>p,default:()=>g,routeModule:()=>_});var a={};t.r(a),t.d(a,{default:()=>v});var i=t(1802),r=t(7153),n=t(6249),c=t(3382);let u=new(t(3524)).PrismaClient;async function d(e,s){try{if("POST"===e.method){let{action:t}=e.body;switch(t){case"bulk_sync":return await o(e,s);case"bulk_update":return await l(e,s);case"bulk_test":return await f(e,s);case"bulk_restart":return await m(e,s);default:return s.status(400).json({success:!1,message:"Invalid action. Supported actions: bulk_sync, bulk_update, bulk_test, bulk_restart"})}}return s.status(405).json({success:!1,message:"Method not allowed"})}catch(e){return s.status(500).json({success:!1,message:"Internal server error"})}finally{await u.$disconnect()}}async function o(e,s){let{device_ids:t}=e.body;if(!t||!Array.isArray(t)||0===t.length)return s.status(400).json({success:!1,message:"device_ids array is required"});let a=[];for(let e of t)try{let s=await u.device.findFirst({where:{device_id:e},include:{cabang:!0}});if(!s){a.push({device_id:e,success:!1,message:"Device not found"});continue}await new Promise(e=>setTimeout(e,1e3+2e3*Math.random()));let t=await u.device.update({where:{id:s.id},data:{last_sync:new Date,status:"aktif"}});await u.deviceStatusLog.create({data:{device_id:s.id,status:"online",firmware_version:s.firmware_version,storage_usage:Math.floor(40*Math.random())+30,timestamp:new Date}}),a.push({device_id:e,success:!0,message:"Sync completed successfully",last_sync:t.last_sync})}catch(s){a.push({device_id:e,success:!1,message:s.message||"Sync failed"})}return s.status(200).json({success:!0,message:`Bulk sync completed for ${a.filter(e=>e.success).length}/${t.length} devices`,data:a})}async function l(e,s){let{device_ids:t,updates:a}=e.body;if(!t||!Array.isArray(t)||0===t.length)return s.status(400).json({success:!1,message:"device_ids array is required"});if(!a||0===Object.keys(a).length)return s.status(400).json({success:!1,message:"updates object is required"});let i=[];for(let e of t)try{let s=await u.device.findFirst({where:{device_id:e}});if(!s){i.push({device_id:e,success:!1,message:"Device not found"});continue}await u.device.update({where:{id:s.id},data:{...a,updated_at:new Date}}),i.push({device_id:e,success:!0,message:"Device updated successfully"})}catch(s){i.push({device_id:e,success:!1,message:s.message||"Update failed"})}return s.status(200).json({success:!0,message:`Bulk update completed for ${i.filter(e=>e.success).length}/${t.length} devices`,data:i})}async function f(e,s){let{device_ids:t}=e.body;if(!t||!Array.isArray(t)||0===t.length)return s.status(400).json({success:!1,message:"device_ids array is required"});let a=[];for(let e of t)try{let s=await u.device.findFirst({where:{device_id:e},include:{cabang:!0}});if(!s){a.push({device_id:e,success:!1,message:"Device not found",connection_status:"unknown"});continue}await new Promise(e=>setTimeout(e,500+1500*Math.random()));let t=Math.random()>.2,i=Math.floor(200*Math.random())+50;await u.device.update({where:{id:s.id},data:{status:t?"aktif":"nonaktif",last_sync:t?new Date:s.last_sync}}),await u.deviceStatusLog.create({data:{device_id:s.id,status:t?"online":"offline",firmware_version:s.firmware_version,error_message:t?null:"Connection timeout",timestamp:new Date}}),a.push({device_id:e,success:t,message:t?"Connection test successful":"Connection test failed",connection_status:t?"online":"offline",response_time:t?i:null})}catch(s){a.push({device_id:e,success:!1,message:s.message||"Test failed",connection_status:"error"})}return s.status(200).json({success:!0,message:`Connection test completed for ${t.length} devices`,data:a})}async function m(e,s){let{device_ids:t}=e.body;if(!t||!Array.isArray(t)||0===t.length)return s.status(400).json({success:!1,message:"device_ids array is required"});let a=[];for(let e of t)try{let s=await u.device.findFirst({where:{device_id:e}});if(!s){a.push({device_id:e,success:!1,message:"Device not found"});continue}await new Promise(e=>setTimeout(e,2e3+3e3*Math.random())),await u.device.update({where:{id:s.id},data:{status:"aktif",last_sync:new Date}}),await u.deviceStatusLog.create({data:{device_id:s.id,status:"online",firmware_version:s.firmware_version,error_message:"Device restarted successfully",timestamp:new Date}}),a.push({device_id:e,success:!0,message:"Device restarted successfully"})}catch(s){a.push({device_id:e,success:!1,message:s.message||"Restart failed"})}return s.status(200).json({success:!0,message:`Bulk restart completed for ${a.filter(e=>e.success).length}/${t.length} devices`,data:a})}let v=(0,c.c)(d),g=(0,n.l)(a,"default"),p=(0,n.l)(a,"config"),_=new i.PagesAPIRouteModule({definition:{kind:r.x.PAGES_API,page:"/api/devices/bulk-operations",pathname:"/api/devices/bulk-operations",bundlePath:"",filename:""},userland:a})},3382:(e,s,t)=>{t.d(s,{Q:()=>r,c:()=>n});var a=t(9344),i=t.n(a);function r(e,s){return async(t,a)=>{try{let r=t.headers.authorization;if(!r||!r.startsWith("Bearer "))return a.status(401).json({message:"No token provided"});let n=r.substring(7),c=i().verify(n,"afms-production-jwt-secret-key-2024-ultra-secure-random-string-xyz789");if(!c||!c.id)return a.status(401).json({message:"Token tidak valid"});if(t.user={id:c.id,userId:parseInt(c.id)||1,email:c.email||"",name:c.name||"",role:c.role||"admin"},s&&!(Array.isArray(s)?s:[s]).includes(t.user.role))return a.status(403).json({message:"Insufficient permissions"});return await e(t,a)}catch(e){return a.status(401).json({message:"Token tidak valid"})}}}function n(e){return r(e,"admin")}},7153:(e,s)=>{var t;Object.defineProperty(s,"x",{enumerable:!0,get:function(){return t}}),function(e){e.PAGES="PAGES",e.PAGES_API="PAGES_API",e.APP_PAGE="APP_PAGE",e.APP_ROUTE="APP_ROUTE"}(t||(t={}))},1802:(e,s,t)=>{e.exports=t(145)}};var s=require("../../../webpack-api-runtime.js");s.C(e);var t=s(s.s=9111);module.exports=t})();