"use strict";(()=>{var e={};e.id=8477,e.ids=[8477],e.modules={3524:e=>{e.exports=require("@prisma/client")},9344:e=>{e.exports=require("jsonwebtoken")},145:e=>{e.exports=require("next/dist/compiled/next-server/pages-api.runtime.prod.js")},6249:(e,t)=>{Object.defineProperty(t,"l",{enumerable:!0,get:function(){return function e(t,s){return s in t?t[s]:"then"in t&&"function"==typeof t.then?t.then(t=>e(t,s)):"function"==typeof t&&"default"===s?t:void 0}}})},5847:(e,t,s)=>{s.r(t),s.d(t,{config:()=>m,default:()=>p,routeModule:()=>g});var a={};s.r(a),s.d(a,{default:()=>l});var r=s(1802),n=s(7153),i=s(6249),u=s(3524),c=s(3382);let o=new u.PrismaClient;async function d(e,t){try{if("POST"===e.method){let{device_id:s,nama:a,tipe:r,cabang_id:n,ip_address:i,port:u,lokasi:c,keterangan:d,firmware_version:l,registration_key:p}=e.body,m=process.env.DEVICE_REGISTRATION_KEY||"default-key-123";if(p!==m)return t.status(401).json({success:!1,message:"Invalid registration key"});if(!s||!a||!r||!n)return t.status(400).json({success:!1,message:"Field yang diperlukan tidak lengkap: device_id, nama, tipe, cabang_id"});if(await o.device.findUnique({where:{device_id:s}}))return t.status(409).json({success:!1,message:"Device ID already exists"});if(!await o.cabang.findUnique({where:{id:parseInt(n.toString())}}))return t.status(404).json({success:!1,message:"Cabang tidak ditemukan"});let g=await o.device.create({data:{device_id:s,nama:a,tipe:r,cabang_id:parseInt(n.toString()),ip_address:i,port:u?parseInt(u):null,lokasi:c,keterangan:d,firmware_version:l,status:"aktif",last_sync:new Date,created_at:new Date,updated_at:new Date},include:{cabang:{select:{id:!0,nama_cabang:!0,alamat_cabang:!0}}}}),_={server_url:process.env.CLOUD_SERVER_URL||"https://your-cloud-server.com/api",api_key:process.env.CLOUD_API_KEY||"your-api-key",sync_interval:parseInt(process.env.SYNC_INTERVAL||"300"),retry_attempts:parseInt(process.env.RETRY_ATTEMPTS||"3"),timeout:parseInt(process.env.TIMEOUT||"30000")};return await o.deviceStatusLog.create({data:{device_id:g.id,status:"online",firmware_version:l,error_message:null,employee_count:0,storage_usage:0,timestamp:new Date}}),t.status(201).json({success:!0,message:"Perangkat berhasil didaftarkan",data:{device:g,cloud_config:_}})}if("GET"===e.method){let{device_id:s}=e.query;if(!s)return t.status(400).json({success:!1,message:"Device ID wajib diisi"});let a=await o.device.findUnique({where:{device_id:s},include:{cabang:{select:{id:!0,nama_cabang:!0,alamat_cabang:!0}}}});if(!a)return t.status(404).json({success:!1,message:"Perangkat tidak ditemukan"});let r={server_url:process.env.CLOUD_SERVER_URL||"https://your-cloud-server.com/api",api_key:process.env.CLOUD_API_KEY||"your-api-key",sync_interval:parseInt(process.env.SYNC_INTERVAL||"300"),retry_attempts:parseInt(process.env.RETRY_ATTEMPTS||"3"),timeout:parseInt(process.env.TIMEOUT||"30000")};return t.status(200).json({success:!0,data:{device:a,cloud_config:r}})}return t.status(405).json({success:!1,message:"Method not allowed"})}catch(e){return t.status(500).json({success:!1,message:"Terjadi kesalahan server"})}finally{await o.$disconnect()}}let l=(0,c.c)(d),p=(0,i.l)(a,"default"),m=(0,i.l)(a,"config"),g=new r.PagesAPIRouteModule({definition:{kind:n.x.PAGES_API,page:"/api/devices/register",pathname:"/api/devices/register",bundlePath:"",filename:""},userland:a})},3382:(e,t,s)=>{s.d(t,{Q:()=>n,c:()=>i});var a=s(9344),r=s.n(a);function n(e,t){return async(s,a)=>{try{let n=s.headers.authorization;if(!n||!n.startsWith("Bearer "))return a.status(401).json({message:"No token provided"});let i=n.substring(7),u=r().verify(i,"afms-production-jwt-secret-key-2024-ultra-secure-random-string-xyz789");if(!u||!u.id)return a.status(401).json({message:"Token tidak valid"});if(s.user={id:u.id,userId:parseInt(u.id)||1,email:u.email||"",name:u.name||"",role:u.role||"admin"},t&&!(Array.isArray(t)?t:[t]).includes(s.user.role))return a.status(403).json({message:"Insufficient permissions"});return await e(s,a)}catch(e){return a.status(401).json({message:"Token tidak valid"})}}}function i(e){return n(e,"admin")}},7153:(e,t)=>{var s;Object.defineProperty(t,"x",{enumerable:!0,get:function(){return s}}),function(e){e.PAGES="PAGES",e.PAGES_API="PAGES_API",e.APP_PAGE="APP_PAGE",e.APP_ROUTE="APP_ROUTE"}(s||(s={}))},1802:(e,t,s)=>{e.exports=s(145)}};var t=require("../../../webpack-api-runtime.js");t.C(e);var s=t(t.s=5847);module.exports=s})();