"use strict";(()=>{var e={};e.id=5963,e.ids=[5963],e.modules={3524:e=>{e.exports=require("@prisma/client")},9344:e=>{e.exports=require("jsonwebtoken")},145:e=>{e.exports=require("next/dist/compiled/next-server/pages-api.runtime.prod.js")},6249:(e,t)=>{Object.defineProperty(t,"l",{enumerable:!0,get:function(){return function e(t,a){return a in t?t[a]:"then"in t&&"function"==typeof t.then?t.then(t=>e(t,a)):"function"==typeof t&&"default"===a?t:void 0}}})},5252:(e,t,a)=>{a.r(t),a.d(t,{config:()=>g,default:()=>f,routeModule:()=>p});var n={};a.r(n),a.d(n,{default:()=>_});var s=a(1802),r=a(7153),i=a(6249),o=a(3524),d=a(3382);let u=new o.PrismaClient;async function c(e,t){return"GET"===e.method?l(e,t):"POST"===e.method?m(e,t):t.status(405).json({message:"Method not allowed"})}async function l(e,t){try{let{cabang_id:a}=e.query,n={};e.user?.role!=="admin"?n.cabang_id=parseInt(e.user?.cabang_id||"0"):a&&(n.cabang_id=parseInt(a));let s=await u.device.findMany({where:n,include:{cabang:{select:{id:!0,nama_cabang:!0,kode_cabang:!0}},statusLogs:{orderBy:{timestamp:"desc"},take:1},attendance:{where:{attendance_time:{gte:new Date(Date.now()-864e5)}},select:{id:!0,attendance_time:!0,user_id:!0}}},orderBy:{updated_at:"desc"}}),r=s.map(e=>{let t=e.statusLogs[0],a=e.attendance.filter(e=>{let t=new Date;return new Date(e.attendance_time).toDateString()===t.toDateString()}),n="offline";if(e.last_sync){let a=new Date(e.last_sync),s=(Date.now()-a.getTime())/6e4;n=s<=5?"online":s<=30&&t?.error_message?"error":"offline"}return{id:e.id,device_id:e.device_id,nama:e.nama,tipe:e.tipe,status:n,cabang:e.cabang,ip_address:e.ip_address,port:e.port,lokasi:e.lokasi,last_sync:e.last_sync,firmware_version:e.firmware_version,employee_count:t?.employee_count||0,storage_usage:t?.storage_usage||0,temperature:t?Math.floor(40*Math.random())+30:null,memory_usage:t?Math.floor(50*Math.random())+30:null,error_message:t?.error_message,today_attendance_count:a.length,total_attendance_count:e.attendance.length,created_at:e.created_at,updated_at:e.updated_at}}),i={total_devices:s.length,online_devices:r.filter(e=>"online"===e.status).length,offline_devices:r.filter(e=>"offline"===e.status).length,error_devices:r.filter(e=>"error"===e.status).length,total_attendance_today:r.reduce((e,t)=>e+t.today_attendance_count,0),last_updated:new Date().toISOString()};t.status(200).json({success:!0,data:{devices:r,summary:i}})}catch(e){t.status(500).json({success:!1,message:"Gagal mengambil data monitoring device",error:e instanceof Error?e.message:"Unknown error"})}}async function m(e,t){try{let{device_id:a,status:n,firmware_version:s,employee_count:r,storage_usage:i,error_message:o}=e.body;if(!a)return t.status(400).json({success:!1,message:"Device ID is required"});let d=await u.device.findUnique({where:{device_id:a}});if(!d)return t.status(404).json({success:!1,message:"Device not found"});let c=await u.device.update({where:{device_id:a},data:{status:n||d.status,last_sync:new Date,firmware_version:s||d.firmware_version,updated_at:new Date}});await u.deviceStatusLog.create({data:{device_id:d.id,status:n||d.status,firmware_version:s||d.firmware_version,employee_count:r||0,storage_usage:i||0,error_message:o||null,timestamp:new Date}}),t.status(200).json({success:!0,message:"Device status updated successfully",data:c})}catch(e){t.status(500).json({success:!1,message:"Gagal mengupdate status device",error:e instanceof Error?e.message:"Unknown error"})}finally{await u.$disconnect()}}let _=(0,d.Q)(c),f=(0,i.l)(n,"default"),g=(0,i.l)(n,"config"),p=new s.PagesAPIRouteModule({definition:{kind:r.x.PAGES_API,page:"/api/devices/monitor",pathname:"/api/devices/monitor",bundlePath:"",filename:""},userland:n})},3382:(e,t,a)=>{a.d(t,{Q:()=>r,c:()=>i});var n=a(9344),s=a.n(n);function r(e,t){return async(a,n)=>{try{let r=a.headers.authorization;if(!r||!r.startsWith("Bearer "))return n.status(401).json({message:"No token provided"});let i=r.substring(7),o=s().verify(i,"afms-production-jwt-secret-key-2024-ultra-secure-random-string-xyz789");if(!o||!o.id)return n.status(401).json({message:"Token tidak valid"});if(a.user={id:o.id,userId:parseInt(o.id)||1,email:o.email||"",name:o.name||"",role:o.role||"admin"},t&&!(Array.isArray(t)?t:[t]).includes(a.user.role))return n.status(403).json({message:"Insufficient permissions"});return await e(a,n)}catch(e){return n.status(401).json({message:"Token tidak valid"})}}}function i(e){return r(e,"admin")}},7153:(e,t)=>{var a;Object.defineProperty(t,"x",{enumerable:!0,get:function(){return a}}),function(e){e.PAGES="PAGES",e.PAGES_API="PAGES_API",e.APP_PAGE="APP_PAGE",e.APP_ROUTE="APP_ROUTE"}(a||(a={}))},1802:(e,t,a)=>{e.exports=a(145)}};var t=require("../../../webpack-api-runtime.js");t.C(e);var a=t(t.s=5252);module.exports=a})();