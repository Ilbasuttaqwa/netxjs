"use strict";(()=>{var e={};e.id=5781,e.ids=[5781],e.modules={9344:e=>{e.exports=require("jsonwebtoken")},145:e=>{e.exports=require("next/dist/compiled/next-server/pages-api.runtime.prod.js")},6249:(e,t)=>{Object.defineProperty(t,"l",{enumerable:!0,get:function(){return function e(t,r){return r in t?t[r]:"then"in t&&"function"==typeof t.then?t.then(t=>e(t,r)):"function"==typeof t&&"default"===r?t:void 0}}})},8847:(e,t,r)=>{r.r(t),r.d(t,{config:()=>y,default:()=>h,routeModule:()=>_});var a={};r.r(a),r.d(a,{default:()=>f});var n=r(1802),i=r(7153),s=r(6249),o=r(3382);let d=[],u=[],c=async(e,t)=>{if("GET"===e.method){t.writeHead(200,{"Content-Type":"text/event-stream","Cache-Control":"no-cache",Connection:"keep-alive","Access-Control-Allow-Origin":"*","Access-Control-Allow-Headers":"Cache-Control"});let r=Date.now();u.push({id:r,response:t}),t.write(`data: ${JSON.stringify({type:"connected",clientId:r})}

`);let a=setInterval(()=>{t.write(`data: ${JSON.stringify({type:"ping",timestamp:new Date().toISOString()})}

`)},3e4);e.on("close",()=>{clearInterval(a),u=u.filter(e=>e.id!==r)});return}if("POST"===e.method)try{let r=e.body;if(!r.device_id||!r.user_id||!r.timestamp)return t.status(400).json({success:!1,message:"Device ID, User ID, dan timestamp diperlukan"});let a={id:Date.now(),karyawan_id:parseInt(r.user_id),device_id:r.device_id,timestamp:r.timestamp,type:0===r.in_out_mode?"masuk":"keluar",verify_method:l(r.verify_type),status:m(r),created_at:new Date().toISOString()};return d.push(a),d.length>100&&(d=d.slice(-100)),p({type:"attendance_record",data:a}),t.status(200).json({success:!0,message:"Data kehadiran berhasil diproses",data:a})}catch(e){return t.status(500).json({success:!1,message:"Gagal memproses data fingerprint"})}return"DELETE"===e.method?(d=[],p({type:"records_cleared",data:null}),t.status(200).json({success:!0,message:"Semua rekaman berhasil dihapus"})):t.status(405).json({success:!1,message:"Method tidak diizinkan"})};function l(e){switch(e){case 1:default:return"fingerprint";case 15:return"face";case 2:return"card"}}function m(e){let t=new Date(e.timestamp),r=t.getHours(),a=t.getMinutes();return 0===e.in_out_mode?r>8||8===r&&a>0?"terlambat":"hadir":r<17?"pulang_cepat":"hadir"}function p(e){let t=`data: ${JSON.stringify(e)}

`;u.forEach((e,r)=>{try{e.response.write(t)}catch(e){u.splice(r,1)}})}setInterval(()=>{if(u.length>0){let e={device_id:"FP001",user_id:Math.floor(10*Math.random()+1).toString(),timestamp:new Date().toISOString(),verify_type:Math.random()>.5?1:15,in_out_mode:Math.random()>.5?0:1,work_code:0},t={id:Date.now(),karyawan_id:parseInt(e.user_id),device_id:e.device_id,timestamp:e.timestamp,type:0===e.in_out_mode?"masuk":"keluar",verify_method:l(e.verify_type),status:m(e),created_at:new Date().toISOString()};d.push(t),p({type:"attendance_record",data:t})}},1e4);let f=async(e,t)=>(!e.headers.authorization&&e.query.token&&(e.headers.authorization=`Bearer ${e.query.token}`),(0,o.Q)(c)(e,t)),h=(0,s.l)(a,"default"),y=(0,s.l)(a,"config"),_=new n.PagesAPIRouteModule({definition:{kind:i.x.PAGES_API,page:"/api/fingerprint/realtime",pathname:"/api/fingerprint/realtime",bundlePath:"",filename:""},userland:a})},3382:(e,t,r)=>{r.d(t,{Q:()=>i,c:()=>s});var a=r(9344),n=r.n(a);function i(e,t){return async(r,a)=>{try{let i=r.headers.authorization;if(!i||!i.startsWith("Bearer "))return a.status(401).json({message:"No token provided"});let s=i.substring(7),o=n().verify(s,"your-super-secret-jwt-key-here-development");if(!o||!o.id)return a.status(401).json({message:"Invalid token"});if(r.user={id:o.id,userId:parseInt(o.id)||1,email:o.email||"",name:o.name||"",role:o.role||"admin"},t&&!(Array.isArray(t)?t:[t]).includes(r.user.role))return a.status(403).json({message:"Insufficient permissions"});return await e(r,a)}catch(e){return a.status(401).json({message:"Invalid token"})}}}function s(e){return i(e,"admin")}},7153:(e,t)=>{var r;Object.defineProperty(t,"x",{enumerable:!0,get:function(){return r}}),function(e){e.PAGES="PAGES",e.PAGES_API="PAGES_API",e.APP_PAGE="APP_PAGE",e.APP_ROUTE="APP_ROUTE"}(r||(r={}))},1802:(e,t,r)=>{e.exports=r(145)}};var t=require("../../../webpack-api-runtime.js");t.C(e);var r=t(t.s=8847);module.exports=r})();