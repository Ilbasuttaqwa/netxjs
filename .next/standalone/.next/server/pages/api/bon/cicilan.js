"use strict";(()=>{var e={};e.id=7140,e.ids=[7140],e.modules={9344:e=>{e.exports=require("jsonwebtoken")},145:e=>{e.exports=require("next/dist/compiled/next-server/pages-api.runtime.prod.js")},6249:(e,a)=>{Object.defineProperty(a,"l",{enumerable:!0,get:function(){return function e(a,t){return t in a?a[t]:"then"in a&&"function"==typeof a.then?a.then(a=>e(a,t)):"function"==typeof a&&"default"===t?a:void 0}}})},6969:(e,a,t)=>{t.r(a),t.d(a,{config:()=>g,default:()=>_,routeModule:()=>f});var n={};t.r(n),t.d(n,{default:()=>p});var s=t(1802),i=t(7153),r=t(6249),d=t(3382);let u=[{id:1,karyawan_id:1,jumlah_bon:5e6,sisa_bon:3e6,cicilan_per_bulan:5e5,tanggal_pengajuan:"2024-01-15",tanggal_persetujuan:"2024-01-16",status:"approved",keterangan:"Bon untuk keperluan mendesak",approved_by:1,created_at:"2024-01-15T00:00:00.000Z",updated_at:"2024-01-16T00:00:00.000Z"},{id:2,karyawan_id:2,jumlah_bon:3e6,sisa_bon:3e6,cicilan_per_bulan:3e5,tanggal_pengajuan:"2024-01-20",tanggal_persetujuan:"2024-01-21",status:"approved",keterangan:"Bon untuk biaya pendidikan anak",approved_by:1,created_at:"2024-01-20T00:00:00.000Z",updated_at:"2024-01-21T00:00:00.000Z"}],o=[{id:1,bon_id:1,periode:"2024-01",jumlah_cicilan:5e5,tanggal_potong:"2024-01-31",status:"processed",created_at:"2024-01-31T00:00:00.000Z",updated_at:"2024-01-31T00:00:00.000Z"},{id:2,bon_id:1,periode:"2024-02",jumlah_cicilan:5e5,tanggal_potong:"2024-02-29",status:"processed",created_at:"2024-02-29T00:00:00.000Z",updated_at:"2024-02-29T00:00:00.000Z"}],l=3;async function c(e,a){try{switch(e.method){case"GET":let{periode:t,karyawan_id:n,bon_id:s}=e.query,i=[...o];if(t&&(i=i.filter(e=>e.periode===t)),s&&(i=i.filter(e=>e.bon_id===parseInt(s.toString()))),n){let e=u.filter(e=>e.karyawan_id===parseInt(n.toString())).map(e=>e.id);i=i.filter(a=>e.includes(a.bon_id))}let r=i.map(e=>({...e,bon:u.find(a=>a.id===e.bon_id)}));return a.status(200).json({success:!0,message:"Data cicilan bon berhasil diambil",data:r});case"POST":let{periode:d}=e.body;if(!d)return a.status(400).json({success:!1,message:"Periode harus diisi"});let c=[];for(let e of u.filter(e=>"approved"===e.status&&e.sisa_bon>0))if(!o.find(a=>a.bon_id===e.id&&a.periode===d)){let a=Math.min(e.cicilan_per_bulan,e.sisa_bon),t={id:l++,bon_id:e.id,periode:d,jumlah_cicilan:a,tanggal_potong:new Date().toISOString().split("T")[0],status:"processed",created_at:new Date().toISOString(),updated_at:new Date().toISOString()};o.push(t),c.push(t),e.sisa_bon-=a,e.sisa_bon<=0&&(e.status="completed"),e.updated_at=new Date().toISOString()}return a.status(201).json({success:!0,message:`Berhasil memproses ${c.length} cicilan bon untuk periode ${d}`,data:c});case"PUT":let{id:p}=e.query,{status:_}=e.body;if(!p)return a.status(400).json({success:!1,message:"ID cicilan harus diisi"});let g=o.findIndex(e=>e.id===parseInt(p.toString()));if(-1===g)return a.status(404).json({success:!1,message:"Cicilan tidak ditemukan"});if(_&&["pending","processed","cancelled"].includes(_)&&(o[g].status=_,o[g].updated_at=new Date().toISOString(),"cancelled"===_)){let e=u.find(e=>e.id===o[g].bon_id);e&&(e.sisa_bon+=o[g].jumlah_cicilan,e.status="approved",e.updated_at=new Date().toISOString())}return a.status(200).json({success:!0,message:"Status cicilan berhasil diperbarui",data:o[g]});default:return a.setHeader("Allow",["GET","POST","PUT"]),a.status(405).json({success:!1,message:`Method ${e.method} tidak diizinkan`})}}catch(e){return a.status(500).json({success:!1,message:"Terjadi kesalahan server"})}}let p=(0,d.c)(c),_=(0,r.l)(n,"default"),g=(0,r.l)(n,"config"),f=new s.PagesAPIRouteModule({definition:{kind:i.x.PAGES_API,page:"/api/bon/cicilan",pathname:"/api/bon/cicilan",bundlePath:"",filename:""},userland:n})},3382:(e,a,t)=>{t.d(a,{Q:()=>i,c:()=>r});var n=t(9344),s=t.n(n);function i(e,a){return async(t,n)=>{try{let i=t.headers.authorization;if(!i||!i.startsWith("Bearer "))return n.status(401).json({message:"No token provided"});let r=i.substring(7),d=s().verify(r,"afms-jwt-secret-key-2024");if(!d||!d.id)return n.status(401).json({message:"Token tidak valid"});if(t.user={id:d.id,userId:parseInt(d.id)||1,email:d.email||"",name:d.name||"",role:d.role||"admin"},a&&!(Array.isArray(a)?a:[a]).includes(t.user.role))return n.status(403).json({message:"Insufficient permissions"});return await e(t,n)}catch(e){return n.status(401).json({message:"Token tidak valid"})}}}function r(e){return i(e,"admin")}},7153:(e,a)=>{var t;Object.defineProperty(a,"x",{enumerable:!0,get:function(){return t}}),function(e){e.PAGES="PAGES",e.PAGES_API="PAGES_API",e.APP_PAGE="APP_PAGE",e.APP_ROUTE="APP_ROUTE"}(t||(t={}))},1802:(e,a,t)=>{e.exports=t(145)}};var a=require("../../../webpack-api-runtime.js");a.C(e);var t=a(a.s=6969);module.exports=t})();