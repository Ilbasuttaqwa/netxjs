"use strict";(()=>{var e={};e.id=8299,e.ids=[8299],e.modules={3524:e=>{e.exports=require("@prisma/client")},145:e=>{e.exports=require("next/dist/compiled/next-server/pages-api.runtime.prod.js")},6249:(e,t)=>{Object.defineProperty(t,"l",{enumerable:!0,get:function(){return function e(t,i){return i in t?t[i]:"then"in t&&"function"==typeof t.then?t.then(t=>e(t,i)):"function"==typeof t&&"default"===i?t:void 0}}})},7896:(e,t,i)=>{i.r(t),i.d(t,{config:()=>u,default:()=>c,routeModule:()=>l});var a={};i.r(a),i.d(a,{default:()=>o});var n=i(1802),r=i(7153),s=i(6249);let d=new(i(3524)).PrismaClient;async function o(e,t){if(t.setHeader("Access-Control-Allow-Origin","*"),t.setHeader("Access-Control-Allow-Methods","POST, OPTIONS"),t.setHeader("Access-Control-Allow-Headers","Content-Type, Authorization"),"OPTIONS"===e.method)return t.status(200).end();if("POST"!==e.method)return t.status(405).json({message:"Method not allowed"});try{let i=e.body;if(!i.device_id||!i.logs)return t.status(400).json({success:!1,message:"Device ID and logs are required"});let a=await d.device.findUnique({where:{device_id:i.device_id},include:{cabang:!0}});if(!a)return t.status(404).json({success:!1,message:"Device not found"});let n=[],r=[];for(let e of i.logs)try{let t=await d.user.findFirst({where:{device_user_id:e.device_user_id,id_cabang:a.cabang_id}});if(!t){r.push({device_user_id:e.device_user_id,error:"User not found"});continue}let i=new Date(e.attendance_time),s=`${a.id}_${t.id}_${i.getTime()}`;if(await d.attendanceDeduplication.findFirst({where:{deviceId:a.id.toString(),employeeId:t.id.toString(),timestamp:{gte:new Date(i.getTime()-3e5),lte:new Date(i.getTime()+3e5)}}}))continue;await d.attendanceDeduplication.create({data:{deviceId:a.id.toString(),employeeId:t.id.toString(),fingerprintHash:s,timestamp:i}});let o=await d.fingerprintAttendance.create({data:{user_id:t.id,device_user_id:e.device_user_id,attendance_time:i,fingerprint_id:e.fingerprint_id||null,verification_type:e.verification_type||"fingerprint",cabang_id:a.cabang_id,device_id:a.id.toString()}});i.getHours();let c="masuk",u=new Date(i);u.setHours(0,0,0,0);let l=new Date(i);l.setHours(23,59,59,999);let _=await d.absensi.findFirst({where:{id_user:t.id,tanggal:{gte:u,lte:l}}});_&&_.jam_masuk&&(c="keluar");let g=new Date(i);if(g.setHours(0,0,0,0),"masuk"===c){let e=await d.absensi.findFirst({where:{id_user:t.id,tanggal:g}});e?await d.absensi.update({where:{id:e.id},data:{jam_masuk:i,status:"hadir",updated_at:new Date}}):await d.absensi.create({data:{id_user:t.id,tanggal:g,jam_masuk:i,status:"hadir",id_cabang:a.cabang_id}})}else{let e=await d.absensi.findFirst({where:{id_user:t.id,tanggal:g}});e&&await d.absensi.update({where:{id:e.id},data:{jam_keluar:i,updated_at:new Date}})}n.push({device_user_id:e.device_user_id,user_id:t.id,attendance_time:i,type:c,fingerprint_attendance_id:o.id})}catch(t){r.push({device_user_id:e.device_user_id,error:t instanceof Error?t.message:"Unknown error"})}await d.device.update({where:{id:a.id},data:{last_sync:new Date,updated_at:new Date}}),await d.deviceStatusLog.create({data:{device_id:a.id,status:"online",firmware_version:a.firmware_version,employee_count:n.length,storage_usage:0,timestamp:new Date}}),t.status(200).json({success:!0,message:`Successfully processed ${n.length} attendance logs`,data:{device_id:i.device_id,processed_count:n.length,error_count:r.length,processed_logs:n,errors:r,sync_timestamp:new Date().toISOString()}})}catch(e){t.status(500).json({success:!1,message:"Internal server error",error:e instanceof Error?e.message:"Unknown error"})}finally{await d.$disconnect()}}let c=(0,s.l)(a,"default"),u=(0,s.l)(a,"config"),l=new n.PagesAPIRouteModule({definition:{kind:r.x.PAGES_API,page:"/api/attendance/sync",pathname:"/api/attendance/sync",bundlePath:"",filename:""},userland:a})},7153:(e,t)=>{var i;Object.defineProperty(t,"x",{enumerable:!0,get:function(){return i}}),function(e){e.PAGES="PAGES",e.PAGES_API="PAGES_API",e.APP_PAGE="APP_PAGE",e.APP_ROUTE="APP_ROUTE"}(i||(i={}))},1802:(e,t,i)=>{e.exports=i(145)}};var t=require("../../../webpack-api-runtime.js");t.C(e);var i=t(t.s=7896);module.exports=i})();