"use strict";(()=>{var e={};e.id=9562,e.ids=[9562],e.modules={3524:e=>{e.exports=require("@prisma/client")},9344:e=>{e.exports=require("jsonwebtoken")},145:e=>{e.exports=require("next/dist/compiled/next-server/pages-api.runtime.prod.js")},6249:(e,t)=>{Object.defineProperty(t,"l",{enumerable:!0,get:function(){return function e(t,a){return a in t?t[a]:"then"in t&&"function"==typeof t.then?t.then(t=>e(t,a)):"function"==typeof t&&"default"===a?t:void 0}}})},1674:(e,t,a)=>{a.r(t),a.d(t,{config:()=>_,default:()=>m,routeModule:()=>p});var s={};a.r(s),a.d(s,{default:()=>g});var n=a(1802),r=a(7153),i=a(6249),o=a(3382);let c=new(a(3524)).PrismaClient;async function u(e,t){try{switch(e.method){case"GET":return await l(e,t);case"POST":return await d(e,t);default:return t.status(405).json({success:!1,message:"Method not allowed"})}}catch(e){return t.status(500).json({success:!1,message:"Terjadi kesalahan server"})}finally{await c.$disconnect()}}async function l(e,t){let{device_ids:a,cabang_id:s,start_date:n,end_date:r,metrics:i=["uptime","sync","hardware"],group_by:o="device"}=e.query,u=r?new Date(r):new Date,l=new Date(n||u.getTime()-2592e6);try{let e={};if(a){let t=Array.isArray(a)?a:[a];e.device_id={in:t}}s&&(e.cabang_id=parseInt(s));let n=await c.device.findMany({where:e,include:{cabang:!0,statusLogs:{where:{timestamp:{gte:l,lte:u}},orderBy:{timestamp:"asc"}}}}),r=[];for(let e of n){let t=e.statusLogs,a=t.length,s=t.filter(e=>"online"===e.status),n=a>0?s.length/a*100:0,i=t.filter(e=>null!==e.storage_usage),o=i.length>0?i.reduce((e,t)=>e+(t.storage_usage||0),0)/i.length:0,c=t.filter(e=>null!==e.error_message).length,d=Math.round(.4*n+0+.3*Math.max(0,100-5*c)),g=new Date((l.getTime()+u.getTime())/2),m=t.filter(e=>e.timestamp<g),_=t.filter(e=>e.timestamp>=g),p=m.length>0?m.filter(e=>"online"===e.status).length/m.length*100:0,y=_.length>0?_.filter(e=>"online"===e.status).length/_.length*100:0,f=y>p+5?"improving":y<p-5?"declining":"stable",h={device_id:e.device_id,device_name:e.nama,cabang_name:e.cabang?.nama_cabang||"Unknown",period:`${l.toISOString().split("T")[0]} to ${u.toISOString().split("T")[0]}`,metrics:{uptime_percentage:Math.round(100*n)/100,total_syncs:0,successful_syncs:0,failed_syncs:0,avg_sync_duration:Math.round(0)/100,total_records_synced:0,avg_battery_level:Math.round(0)/100,avg_temperature:Math.round(0)/100,avg_memory_usage:Math.round(0)/100,avg_storage_usage:Math.round(100*o)/100,error_count:c,connection_quality_score:d},trends:{uptime_trend:f,sync_performance_trend:"stable",hardware_health_trend:"stable"}};r.push(h)}let i=r.length,o=i>0?r.reduce((e,t)=>e+t.metrics.uptime_percentage,0)/i:0,d=i>0?r.reduce((e,t)=>e+t.metrics.connection_quality_score,0)/i:0,g=r.reduce((e,t)=>e+t.metrics.total_syncs,0),m=r.reduce((e,t)=>e+t.metrics.successful_syncs,0),_=r.reduce((e,t)=>e+t.metrics.total_records_synced,0);return t.status(200).json({success:!0,data:{analytics:r,summary:{total_devices:i,avg_uptime_percentage:Math.round(100*o)/100,avg_connection_quality_score:Math.round(100*d)/100,total_syncs:g,total_successful_syncs:m,sync_success_rate:g>0?Math.round(m/g*1e4)/100:0,total_records_synced:_,period:`${l.toISOString().split("T")[0]} to ${u.toISOString().split("T")[0]}`,generated_at:new Date}}})}catch(e){return t.status(500).json({success:!1,message:e.message||"Gagal mengambil analitik"})}}async function d(e,t){let{device_ids:a,cabang_id:s,start_date:n,end_date:r,report_type:i="summary",format:o="json"}=e.body;try{let e={report_id:`report_${Date.now()}`,report_type:i,generated_at:new Date,period:{start_date:n||new Date(Date.now()-2592e6).toISOString().split("T")[0],end_date:r||new Date().toISOString().split("T")[0]},filters:{device_ids:a||"all",cabang_id:s||"all"},summary:{total_devices_analyzed:0,avg_uptime:0,total_syncs:0,sync_success_rate:0,total_errors:0},recommendations:[{priority:"high",category:"performance",description:"Consider upgrading devices with consistently low battery levels",affected_devices:[]},{priority:"medium",category:"maintenance",description:"Schedule regular sync operations for devices with low sync frequency",affected_devices:[]}]};return t.status(200).json({success:!0,message:"Laporan berhasil dibuat",data:e})}catch(e){return t.status(500).json({success:!1,message:e.message||"Gagal membuat laporan"})}}let g=(0,o.c)(u),m=(0,i.l)(s,"default"),_=(0,i.l)(s,"config"),p=new n.PagesAPIRouteModule({definition:{kind:r.x.PAGES_API,page:"/api/devices/analytics",pathname:"/api/devices/analytics",bundlePath:"",filename:""},userland:s})},3382:(e,t,a)=>{a.d(t,{Q:()=>r,c:()=>i});var s=a(9344),n=a.n(s);function r(e,t){return async(a,s)=>{try{let r=a.headers.authorization;if(!r||!r.startsWith("Bearer "))return s.status(401).json({message:"No token provided"});let i=r.substring(7),o=n().verify(i,"afms-production-jwt-secret-key-2024-ultra-secure-random-string-xyz789");if(!o||!o.id)return s.status(401).json({message:"Token tidak valid"});if(a.user={id:o.id,userId:parseInt(o.id)||1,email:o.email||"",name:o.name||"",role:o.role||"admin"},t&&!(Array.isArray(t)?t:[t]).includes(a.user.role))return s.status(403).json({message:"Insufficient permissions"});return await e(a,s)}catch(e){return s.status(401).json({message:"Token tidak valid"})}}}function i(e){return r(e,"admin")}},7153:(e,t)=>{var a;Object.defineProperty(t,"x",{enumerable:!0,get:function(){return a}}),function(e){e.PAGES="PAGES",e.PAGES_API="PAGES_API",e.APP_PAGE="APP_PAGE",e.APP_ROUTE="APP_ROUTE"}(a||(a={}))},1802:(e,t,a)=>{e.exports=a(145)}};var t=require("../../../webpack-api-runtime.js");t.C(e);var a=t(t.s=1674);module.exports=a})();