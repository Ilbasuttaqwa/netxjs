"use strict";(()=>{var e={};e.id=5260,e.ids=[5260],e.modules={3524:e=>{e.exports=require("@prisma/client")},9344:e=>{e.exports=require("jsonwebtoken")},145:e=>{e.exports=require("next/dist/compiled/next-server/pages-api.runtime.prod.js")},6249:(e,t)=>{Object.defineProperty(t,"l",{enumerable:!0,get:function(){return function e(t,s){return s in t?t[s]:"then"in t&&"function"==typeof t.then?t.then(t=>e(t,s)):"function"==typeof t&&"default"===s?t:void 0}}})},6132:(e,t,s)=>{s.r(t),s.d(t,{config:()=>f,default:()=>m,routeModule:()=>h});var a={};s.r(a),s.d(a,{default:()=>g});var i=s(1802),n=s(7153),r=s(6249),u=s(3382);let o=new(s(3524)).PrismaClient;async function l(e,t){try{switch(e.method){case"GET":return await d(e,t);case"POST":return await c(e,t);default:return t.status(405).json({success:!1,message:"Method not allowed"})}}catch(e){return t.status(500).json({success:!1,message:"Terjadi kesalahan server"})}finally{await o.$disconnect()}}async function d(e,t){let{device_ids:s,include_history:a=!1,time_range:i="day"}=e.query,n=new Date,r={hour:new Date(n.getTime()-36e5),day:new Date(n.getTime()-864e5),week:new Date(n.getTime()-6048e5),month:new Date(n.getTime()-2592e6)}[i],u={};if(s){let e=Array.isArray(s)?s:[s];u.device_id={in:e}}let l=await o.device.findMany({where:u,include:{cabang:!0,statusLogs:{where:{timestamp:{gte:r}},orderBy:{timestamp:"desc"},take:10}}}),d=[];for(let e of l){let t=e.statusLogs[0],s=e.statusLogs,a=e.statusLogs,r=s.filter(e=>"online"===e.status),u=s.length>0?r.length/s.length*100:0,o="offline",l=[];if(t){let e=(n.getTime()-t.timestamp.getTime())/6e4;"online"===t.status&&e<5?o="healthy":"online"===t.status&&e<30?(o="warning",l.push("Device not responding recently")):"offline"===t.status&&(o="offline",l.push("Device is offline")),t.storage_usage&&t.storage_usage>95&&(o="critical",l.push(`Storage almost full: ${t.storage_usage}%`)),t.error_message&&("healthy"===o&&(o="warning"),l.push(t.error_message))}let c="poor";u>=95?c="excellent":u>=85?c="good":u>=70&&(c="fair");let g=a.filter(e=>"online"===e.status).length/("hour"===i?1:"day"===i?24:"week"===i?168:720),m=s.filter(e=>e.error_message).length,f={device_id:e.device_id,device_name:e.nama,status:o,last_seen:t?.timestamp||e.updated_at,uptime_percentage:Math.round(100*u)/100,issues:l,metrics:{storage_usage:t?.storage_usage||void 0,connection_quality:c,sync_frequency:Math.round(100*g)/100,error_count:m}};d.push(f)}let c=d.length,g=d.filter(e=>"healthy"===e.status).length,m=d.filter(e=>"warning"===e.status).length,f=d.filter(e=>"critical"===e.status).length,h=d.filter(e=>"offline"===e.status).length,p=c>0?d.reduce((e,t)=>e+t.uptime_percentage,0)/c:0;return t.status(200).json({success:!0,data:{devices:d,statistics:{total_devices:c,healthy_devices:g,warning_devices:m,critical_devices:f,offline_devices:h,average_uptime:Math.round(100*p)/100,time_range:i,last_updated:new Date},...a&&{history:l.map(e=>({device_id:e.device_id,status_logs:e.statusLogs}))}}})}async function c(e,t){let{device_id:s,metrics:a,status:i,error_message:n}=e.body;if(!s)return t.status(400).json({success:!1,message:"device_id wajib diisi"});try{let e=await o.device.findFirst({where:{device_id:s}});if(!e)return t.status(404).json({success:!1,message:"Perangkat tidak ditemukan"});let r=await o.deviceStatusLog.create({data:{device_id:e.id,status:i||"online",firmware_version:e.firmware_version,storage_usage:a?.storage_usage,error_message:n||null,timestamp:new Date}});return"online"===i&&await o.device.update({where:{id:e.id},data:{last_sync:new Date,status:"aktif"}}),t.status(200).json({success:!0,message:"Status kesehatan berhasil diperbarui",data:r})}catch(e){return t.status(500).json({success:!1,message:e.message||"Gagal memperbarui status kesehatan"})}}let g=(0,u.c)(l),m=(0,r.l)(a,"default"),f=(0,r.l)(a,"config"),h=new i.PagesAPIRouteModule({definition:{kind:n.x.PAGES_API,page:"/api/devices/health-monitor",pathname:"/api/devices/health-monitor",bundlePath:"",filename:""},userland:a})},3382:(e,t,s)=>{s.d(t,{Q:()=>n,c:()=>r});var a=s(9344),i=s.n(a);function n(e,t){return async(s,a)=>{try{let n=s.headers.authorization;if(!n||!n.startsWith("Bearer "))return a.status(401).json({message:"No token provided"});let r=n.substring(7),u=i().verify(r,"afms-jwt-secret-key-2024");if(!u||!u.id)return a.status(401).json({message:"Token tidak valid"});if(s.user={id:u.id,userId:parseInt(u.id)||1,email:u.email||"",name:u.name||"",role:u.role||"admin"},t&&!(Array.isArray(t)?t:[t]).includes(s.user.role))return a.status(403).json({message:"Insufficient permissions"});return await e(s,a)}catch(e){return a.status(401).json({message:"Token tidak valid"})}}}function r(e){return n(e,"admin")}},7153:(e,t)=>{var s;Object.defineProperty(t,"x",{enumerable:!0,get:function(){return s}}),function(e){e.PAGES="PAGES",e.PAGES_API="PAGES_API",e.APP_PAGE="APP_PAGE",e.APP_ROUTE="APP_ROUTE"}(s||(s={}))},1802:(e,t,s)=>{e.exports=s(145)}};var t=require("../../../webpack-api-runtime.js");t.C(e);var s=t(t.s=6132);module.exports=s})();